import { Input, Output, Component, ViewChildren, EventEmitter, HostListener, ChangeDetectionStrategy, } from '@angular/core';
import { UntypedFormArray, UntypedFormControl, Validators, } from '@angular/forms';
import { NgxOtpBehavior, } from './ngx-otp-input.model';
import * as i0 from "@angular/core";
import * as i1 from "../ngx-otp-input.service";
import * as i2 from "@angular/forms";
import * as i3 from "@angular/common";
import * as i4 from "../pattern.directive";
export class NgxOtpInputComponent {
    constructor(ngxOtpInputService, ref) {
        this.ngxOtpInputService = ngxOtpInputService;
        this.ref = ref;
        this.ngxOtpArray = new UntypedFormArray([]);
        this.ariaLabels = [];
        this.styles = [];
        this.otpConfig = {
            otpLength: 6,
            autofocus: true,
            autoblur: true,
            behavior: NgxOtpBehavior.DEFAULT,
        };
        this.defaultPattern = /^\d+$/;
        this.DEFAULT_ARIA_LABEL = 'One time password input';
        this.isNgxOtpArrayDisabled = false;
        this.focusedInputHasValue = false;
        this.otpChange = new EventEmitter();
        this.fill = new EventEmitter();
    }
    onPaste(event) {
        event.preventDefault();
        this.handlePaste(event.clipboardData.getData('text'));
    }
    set disable(isDisabled) {
        this.handleDisable(isDisabled);
        this.isNgxOtpArrayDisabled = isDisabled;
    }
    set config(c) {
        this.otpConfig = { ...this.otpConfig, ...c };
        if (this.otpConfig.classList?.input) {
            this.setInitialStyles();
        }
        if (!c.pattern) {
            this.otpConfig.pattern = this.defaultPattern;
        }
    }
    set status(status) {
        this.handleStatusChange(status);
    }
    ngOnInit() {
        this.setUpOtpForm();
        this.setUpAriaLabels();
        this.LAST_INPUT_INDEX = this.otpConfig.otpLength - 1;
        this.otpFormChangeListener();
    }
    ngAfterViewInit() {
        this.setNativeHTMLElements();
        this.setInitialFocus();
        this.setNumericInputIfPossible();
        this.handleDisable(this.isNgxOtpArrayDisabled);
    }
    ngOnDestroy() {
        this.ngxOtpArray$.unsubscribe();
    }
    clear() {
        this.removeStyleFromAll(this.otpConfig.classList?.inputFilled);
        this.ngxOtpArray.reset();
        this.ref.detectChanges();
        if (this.otpConfig.autofocus) {
            this.setFocus(0);
        }
    }
    handleKeyUp(index, value) {
        if (this.otpConfig.pattern.test(value) && value !== 'Backspace') {
            this.addStyle(index, this.otpConfig.classList?.inputFilled);
            if (!this.ngxOtpArray.valid) {
                this.getFormControlByIndex(index).setValue(value);
                this.stepForward(index);
            }
            else {
                this.blur();
            }
        }
    }
    handleDelete(index) {
        this.removeStyle(index, this.otpConfig.classList?.inputFilled);
        if ((this.otpConfig.behavior === NgxOtpBehavior.LEGACY &&
            !this.focusedInputHasValue) ||
            this.otpConfig.behavior !== NgxOtpBehavior.LEGACY) {
            this.stepBackward(index);
        }
        else {
            this.focusedInputHasValue = false;
        }
    }
    handleFocus(index) {
        this.focusedInputHasValue = !!this.ngxOtpArray.controls[index].value;
        if (this.otpConfig.behavior === NgxOtpBehavior.LEGACY &&
            this.focusedInputHasValue) {
            this.inputs[index].select();
        }
    }
    stepBackward(index) {
        if (index > 0) {
            this.setFocus(index - 1);
        }
    }
    stepForward(index) {
        if (index < this.LAST_INPUT_INDEX) {
            this.setFocus(index + 1);
        }
    }
    otpFormChangeListener() {
        this.ngxOtpArray$ = this.ngxOtpArray.valueChanges.subscribe((values) => {
            this.otpChange.emit(values);
            if (this.ngxOtpArray.valid) {
                this.fill.emit(values.join(''));
            }
        });
    }
    setUpOtpForm() {
        for (let i = 0; i < this.otpConfig.otpLength; i++) {
            this.ngxOtpArray.push(new UntypedFormControl(null, [Validators.required]));
        }
    }
    setUpAriaLabels() {
        const labels = this.otpConfig.ariaLabels;
        this.ariaLabels = Array.isArray(labels)
            ? labels
            : new Array(this.otpConfig.otpLength).fill(labels || this.DEFAULT_ARIA_LABEL);
    }
    setNativeHTMLElements() {
        this.inputs = this.otpInputElements.map((element) => element.nativeElement);
    }
    setInitialFocus() {
        if (this.otpConfig.autofocus) {
            this.setFocus(0);
        }
    }
    setInitialStyles() {
        this.styles = this.ngxOtpInputService.init2DArray(this.otpConfig.otpLength);
        this.addStyleToAll(this.otpConfig.classList.input);
    }
    setFocus(index) {
        this.inputs[index].focus();
    }
    setNumericInputIfPossible() {
        if (this.otpConfig.numericInputMode) {
            this.otpConfig.pattern = this.defaultPattern;
            this.inputs.map((element) => {
                element.setAttribute('inputmode', 'numeric');
                element.setAttribute('pattern', '[0-9]*');
            });
        }
    }
    blur() {
        if (this.otpConfig.autoblur) {
            this.inputs.map((input) => input.blur());
        }
    }
    handlePaste(value) {
        if (this.otpConfig.pattern.test(value)) {
            let lastIndex = 0;
            value
                .split('')
                .slice(0, this.otpConfig.otpLength)
                .map((character, index) => {
                this.addStyle(index, this.otpConfig.classList?.inputFilled);
                this.getFormControlByIndex(index).setValue(character);
                lastIndex = index;
            });
            if (this.ngxOtpArray.valid) {
                this.blur();
            }
            else {
                this.setFocus(lastIndex + 1);
            }
        }
    }
    handleDisable(isDisabled) {
        if (isDisabled) {
            this.ngxOtpArray.disable();
            this.addStyleToAll(this.otpConfig.classList?.inputDisabled);
        }
        else {
            this.ngxOtpArray.enable();
            this.removeStyleFromAll(this.otpConfig.classList?.inputDisabled);
        }
    }
    handleStatusChange(status) {
        this.removeStyleFromAll([
            ...this.ngxOtpInputService.toArray(this.otpConfig.classList?.inputSuccess),
            ...this.ngxOtpInputService.toArray(this.otpConfig.classList?.inputError),
        ]);
        if (status) {
            if (status === 'success') {
                this.addStyleToAll(this.otpConfig.classList?.inputSuccess);
            }
            else if (status === 'error') {
                this.addStyleToAll(this.otpConfig.classList?.inputError);
            }
        }
    }
    getFormControlByIndex(index) {
        return this.ngxOtpArray.controls[index];
    }
    addStyle(index, styles) {
        this.styles = this.ngxOtpInputService.addItemAtIndex(this.styles, index, this.ngxOtpInputService.toArray(styles));
    }
    addStyleToAll(styles) {
        this.styles = this.ngxOtpInputService.addItemToAll(this.styles, this.ngxOtpInputService.toArray(styles));
    }
    removeStyle(index, styles) {
        this.styles = this.ngxOtpInputService.removeItemAtIndex(this.styles, index, this.ngxOtpInputService.toArray(styles));
    }
    removeStyleFromAll(styles) {
        this.styles = this.ngxOtpInputService.removeItemFromAll(this.styles, this.ngxOtpInputService.toArray(styles));
    }
}
NgxOtpInputComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.1", ngImport: i0, type: NgxOtpInputComponent, deps: [{ token: i1.NgxOtpInputService }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component });
NgxOtpInputComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.1", type: NgxOtpInputComponent, selector: "ngx-otp-input", inputs: { disable: "disable", config: "config", status: "status" }, outputs: { otpChange: "otpChange", fill: "fill" }, host: { listeners: { "paste": "onPaste($event)" } }, viewQueries: [{ propertyName: "otpInputElements", predicate: ["otpInputElement"], descendants: true }], ngImport: i0, template: "<form\n  [ngClass]=\"otpConfig.classList?.container\"\n  class=\"ngx-otp-input-container\"\n>\n  <div\n    *ngFor=\"let control of ngxOtpArray.controls; let i = index\"\n    [ngClass]=\"otpConfig.classList?.inputBox\"\n    class=\"ngx-otp-input-box\"\n  >\n    <label [attr.aria-label]=\"ariaLabels[i]\">\n      <input\n        #otpInputElement\n        [id]=\"'ngx-otp-input-' + i\"\n        [formControl]=\"control\"\n        [ngxOtpPattern]=\"otpConfig.pattern\"\n        [type]=\"otpConfig.isPasswordInput ? 'password' : 'text'\"\n          [ngClass]=\"styles?.length > 0 ? styles[i] : null\"\n        (keyup)=\"handleKeyUp(i, $event.key)\"\n        (keyup.backspace)=\"handleDelete(i)\"\n        (keyup.arrowLeft)=\"stepBackward(i)\"\n        (keyup.arrowRight)=\"stepForward(i)\"\n        (focus)=\"handleFocus(i)\"\n        class=\"ngx-otp-input\"\n        maxlength=\"1\"\n        autocapitalize=\"off\"\n        spellcheck=\"false\"\n      />\n    </label>\n  </div>\n</form>\n", styles: [".ngx-otp-input-container{display:flex}.ngx-otp-input-box{margin:0 5px}.ngx-otp-input-box:first-child{margin-left:0}.ngx-otp-input-box:last-child{margin-right:0}.ngx-otp-input{width:35px;height:35px;text-align:center;font-size:1.25rem;border:1px solid #212121;border-radius:4px;outline:0}.ngx-otp-input-disabled{opacity:.3}\n"], dependencies: [{ kind: "directive", type: i2.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i2.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i2.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i2.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i2.MaxLengthValidator, selector: "[maxlength][formControlName],[maxlength][formControl],[maxlength][ngModel]", inputs: ["maxlength"] }, { kind: "directive", type: i2.FormControlDirective, selector: "[formControl]", inputs: ["formControl", "disabled", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }, { kind: "directive", type: i2.NgForm, selector: "form:not([ngNoForm]):not([formGroup]),ng-form,[ngForm]", inputs: ["ngFormOptions"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "directive", type: i3.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i4.PatternDirective, selector: "[ngxOtpPattern]", inputs: ["ngxOtpPattern"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.1", ngImport: i0, type: NgxOtpInputComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ngx-otp-input', changeDetection: ChangeDetectionStrategy.OnPush, template: "<form\n  [ngClass]=\"otpConfig.classList?.container\"\n  class=\"ngx-otp-input-container\"\n>\n  <div\n    *ngFor=\"let control of ngxOtpArray.controls; let i = index\"\n    [ngClass]=\"otpConfig.classList?.inputBox\"\n    class=\"ngx-otp-input-box\"\n  >\n    <label [attr.aria-label]=\"ariaLabels[i]\">\n      <input\n        #otpInputElement\n        [id]=\"'ngx-otp-input-' + i\"\n        [formControl]=\"control\"\n        [ngxOtpPattern]=\"otpConfig.pattern\"\n        [type]=\"otpConfig.isPasswordInput ? 'password' : 'text'\"\n          [ngClass]=\"styles?.length > 0 ? styles[i] : null\"\n        (keyup)=\"handleKeyUp(i, $event.key)\"\n        (keyup.backspace)=\"handleDelete(i)\"\n        (keyup.arrowLeft)=\"stepBackward(i)\"\n        (keyup.arrowRight)=\"stepForward(i)\"\n        (focus)=\"handleFocus(i)\"\n        class=\"ngx-otp-input\"\n        maxlength=\"1\"\n        autocapitalize=\"off\"\n        spellcheck=\"false\"\n      />\n    </label>\n  </div>\n</form>\n", styles: [".ngx-otp-input-container{display:flex}.ngx-otp-input-box{margin:0 5px}.ngx-otp-input-box:first-child{margin-left:0}.ngx-otp-input-box:last-child{margin-right:0}.ngx-otp-input{width:35px;height:35px;text-align:center;font-size:1.25rem;border:1px solid #212121;border-radius:4px;outline:0}.ngx-otp-input-disabled{opacity:.3}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.NgxOtpInputService }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { otpInputElements: [{
                type: ViewChildren,
                args: ['otpInputElement']
            }], otpChange: [{
                type: Output
            }], fill: [{
                type: Output
            }], onPaste: [{
                type: HostListener,
                args: ['paste', ['$event']]
            }], disable: [{
                type: Input
            }], config: [{
                type: Input
            }], status: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW90cC1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtb3RwLWlucHV0L3NyYy9saWIvY29tcG9uZW50L25neC1vdHAtaW5wdXQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW90cC1pbnB1dC9zcmMvbGliL2NvbXBvbmVudC9uZ3gtb3RwLWlucHV0LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxLQUFLLEVBRUwsTUFBTSxFQUNOLFNBQVMsRUFJVCxZQUFZLEVBQ1osWUFBWSxFQUNaLFlBQVksRUFHWix1QkFBdUIsR0FDeEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixrQkFBa0IsRUFDbEIsVUFBVSxHQUNYLE1BQU0sZ0JBQWdCLENBQUM7QUFHeEIsT0FBTyxFQUVMLGNBQWMsR0FFZixNQUFNLHVCQUF1QixDQUFDOzs7Ozs7QUFRL0IsTUFBTSxPQUFPLG9CQUFvQjtJQWtEL0IsWUFDbUIsa0JBQXNDLEVBQ3RDLEdBQXNCO1FBRHRCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFuRHpDLGdCQUFXLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QyxlQUFVLEdBQWEsRUFBRSxDQUFDO1FBRTFCLFdBQU0sR0FBZSxFQUFFLENBQUM7UUFFeEIsY0FBUyxHQUFzQjtZQUM3QixTQUFTLEVBQUUsQ0FBQztZQUNaLFNBQVMsRUFBRSxJQUFJO1lBQ2YsUUFBUSxFQUFFLElBQUk7WUFDZCxRQUFRLEVBQUUsY0FBYyxDQUFDLE9BQU87U0FDakMsQ0FBQztRQUVNLG1CQUFjLEdBQUcsT0FBTyxDQUFDO1FBQ3pCLHVCQUFrQixHQUFHLHlCQUF5QixDQUFDO1FBRy9DLDBCQUFxQixHQUFH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Q0FBQztJQUNKLENBQUM7SUFFTyxXQUFXLENBQUMsS0FBYSxFQUFFLE1BQXlCO1FBQzFELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUNyRCxJQUFJLENBQUMsTUFBTSxFQUNYLEtBQUssRUFDTCxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUN4QyxDQUFDO0lBQ0osQ0FBQztJQUVPLGtCQUFrQixDQUFDLE1BQXlCO1FBQ2xELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUNyRCxJQUFJLENBQUMsTUFBTSxFQUNYLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQ3hDLENBQUM7SUFDSixDQUFDOztpSEFoUlUsb0JBQW9CO3FHQUFwQixvQkFBb0IseVVDbENqQyw0OUJBOEJBOzJGRElhLG9CQUFvQjtrQkFOaEMsU0FBUzsrQkFDRSxlQUFlLG1CQUdSLHVCQUF1QixDQUFDLE1BQU07eUlBdUJkLGdCQUFnQjtzQkFBaEQsWUFBWTt1QkFBQyxpQkFBaUI7Z0JBRXJCLFNBQVM7c0JBQWxCLE1BQU07Z0JBQ0csSUFBSTtzQkFBYixNQUFNO2dCQUU0QixPQUFPO3NCQUF6QyxZQUFZO3VCQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQztnQkFLcEIsT0FBTztzQkFBbkIsS0FBSztnQkFLTyxNQUFNO3NCQUFsQixLQUFLO2dCQVVPLE1BQU07c0JBQWxCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbnB1dCxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIENvbXBvbmVudCxcbiAgT25EZXN0cm95LFxuICBRdWVyeUxpc3QsXG4gIEVsZW1lbnRSZWYsXG4gIFZpZXdDaGlsZHJlbixcbiAgRXZlbnRFbWl0dGVyLFxuICBIb3N0TGlzdGVuZXIsXG4gIEFmdGVyVmlld0luaXQsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBVbnR5cGVkRm9ybUFycmF5LFxuICBVbnR5cGVkRm9ybUNvbnRyb2wsXG4gIFZhbGlkYXRvcnMsXG59IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTmd4T3RwSW5wdXRTZXJ2aWNlIH0gZnJvbSAnLi4vbmd4LW90cC1pbnB1dC5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE5neE90cFN0YXR1cyxcbiAgTmd4T3RwQmVoYXZpb3IsXG4gIE5neE90cElucHV0Q29uZmlnLFxufSBmcm9tICcuL25neC1vdHAtaW5wdXQubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtb3RwLWlucHV0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL25neC1vdHAtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9uZ3gtb3RwLWlucHV0LmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3hPdHBJbnB1dENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgbmd4T3RwQXJyYXkgPSBuZXcgVW50eXBlZEZvcm1BcnJheShbXSk7XG4gIGFyaWFMYWJlbHM6IHN0cmluZ1tdID0gW107XG4gIHBhdHRlcm4hOiBSZWdFeHA7XG4gIHN0eWxlczogc3RyaW5nW11bXSA9IFtdO1xuXG4gIG90cENvbmZpZzogTmd4T3RwSW5wdXRDb25maWcgPSB7XG4gICAgb3RwTGVuZ3RoOiA2LFxuICAgIGF1dG9mb2N1czogdHJ1ZSxcbiAgICBhdXRvYmx1cjogdHJ1ZSxcbiAgICBiZWhhdmlvcjogTmd4T3RwQmVoYXZpb3IuREVGQVVMVCxcbiAgfTtcblxuICBwcml2YXRlIGRlZmF1bHRQYXR0ZXJuID0gL15cXGQrJC87XG4gIHByaXZhdGUgREVGQVVMVF9BUklBX0xBQkVMID0gJ09uZSB0aW1lIHBhc3N3b3JkIGlucHV0JztcbiAgcHJpdmF0ZSBMQVNUX0lOUFVUX0lOREVYITogbnVtYmVyO1xuICBwcml2YXRlIGlucHV0cyE6IEhUTUxJbnB1dEVsZW1lbnRbXTtcbiAgcHJpdmF0ZSBpc05neE90cEFycmF5RGlzYWJsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBuZ3hPdHBBcnJheSQhOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgZm9jdXNlZElucHV0SGFzVmFsdWUgPSBmYWxzZTtcblxuICBAVmlld0NoaWxkcmVuKCdvdHBJbnB1dEVsZW1lbnQnKSBvdHBJbnB1dEVsZW1lbnRzOiBRdWVyeUxpc3Q8RWxlbWVudFJlZj47XG5cbiAgQE91dHB1dCgpIG90cENoYW5nZTogRXZlbnRFbWl0dGVyPHN0cmluZ1tdPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nW10+KCk7XG4gIEBPdXRwdXQoKSBmaWxsOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ3Bhc3RlJywgWyckZXZlbnQnXSkgb25QYXN0ZShldmVudDogQ2xpcGJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHRoaXMuaGFuZGxlUGFzdGUoZXZlbnQuY2xpcGJvYXJkRGF0YS5nZXREYXRhKCd0ZXh0JykpO1xuICB9XG5cbiAgQElucHV0KCkgc2V0IGRpc2FibGUoaXNEaXNhYmxlZDogYm9vbGVhbikge1xuICAgIHRoaXMuaGFuZGxlRGlzYWJsZShpc0Rpc2FibGVkKTtcbiAgICB0aGlzLmlzTmd4T3RwQXJyYXlEaXNhYmxlZCA9IGlzRGlzYWJsZWQ7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgY29uZmlnKGM6IE5neE90cElucHV0Q29uZmlnKSB7XG4gICAgdGhpcy5vdHBDb25maWcgPSB7IC4uLnRoaXMub3RwQ29uZmlnLCAuLi5jIH07XG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLmNsYXNzTGlzdD8uaW5wdXQpIHtcbiAgICAgIHRoaXMuc2V0SW5pdGlhbFN0eWxlcygpO1xuICAgIH1cbiAgICBpZiAoIWMucGF0dGVybikge1xuICAgICAgdGhpcy5vdHBDb25maWcucGF0dGVybiA9IHRoaXMuZGVmYXVsdFBhdHRlcm47XG4gICAgfVxuICB9XG5cbiAgQElucHV0KCkgc2V0IHN0YXR1cyhzdGF0dXM6IE5neE90cFN0YXR1cykge1xuICAgIHRoaXMuaGFuZGxlU3RhdHVzQ2hhbmdlKHN0YXR1cyk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5neE90cElucHV0U2VydmljZTogTmd4T3RwSW5wdXRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHt9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRVcE90cEZvcm0oKTtcbiAgICB0aGlzLnNldFVwQXJpYUxhYmVscygpO1xuICAgIHRoaXMuTEFTVF9JTlBVVF9JTkRFWCA9IHRoaXMub3RwQ29uZmlnLm90cExlbmd0aCAtIDE7XG4gICAgdGhpcy5vdHBGb3JtQ2hhbmdlTGlzdGVuZXIoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnNldE5hdGl2ZUhUTUxFbGVtZW50cygpO1xuICAgIHRoaXMuc2V0SW5pdGlhbEZvY3VzKCk7XG4gICAgdGhpcy5zZXROdW1lcmljSW5wdXRJZlBvc3NpYmxlKCk7XG4gICAgdGhpcy5oYW5kbGVEaXNhYmxlKHRoaXMuaXNOZ3hPdHBBcnJheURpc2FibGVkKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMubmd4T3RwQXJyYXkkLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLnJlbW92ZVN0eWxlRnJvbUFsbCh0aGlzLm90cENvbmZpZy5jbGFzc0xpc3Q/LmlucHV0RmlsbGVkKTtcbiAgICB0aGlzLm5neE90cEFycmF5LnJlc2V0KCk7XG4gICAgdGhpcy5yZWYuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLmF1dG9mb2N1cykge1xuICAgICAgdGhpcy5zZXRGb2N1cygwKTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVLZXlVcChpbmRleDogbnVtYmVyLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLnBhdHRlcm4udGVzdCh2YWx1ZSkgJiYgdmFsdWUgIT09ICdCYWNrc3BhY2UnKSB7XG4gICAgICB0aGlzLmFkZFN0eWxlKGluZGV4LCB0aGlzLm90cENvbmZpZy5jbGFzc0xpc3Q/LmlucHV0RmlsbGVkKTtcbiAgICAgIGlmICghdGhpcy5uZ3hPdHBBcnJheS52YWxpZCkge1xuICAgICAgICB0aGlzLmdldEZvcm1Db250cm9sQnlJbmRleChpbmRleCkuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgICB0aGlzLnN0ZXBGb3J3YXJkKGluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYmx1cigpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZURlbGV0ZShpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5yZW1vdmVTdHlsZShpbmRleCwgdGhpcy5vdHBDb25maWcuY2xhc3NMaXN0Py5pbnB1dEZpbGxlZCk7XG4gICAgaWYgKFxuICAgICAgKHRoaXMub3RwQ29uZmlnLmJlaGF2aW9yID09PSBOZ3hPdHBCZWhhdmlvci5MRUdBQ1kgJiZcbiAgICAgICAgIXRoaXMuZm9jdXNlZElucHV0SGFzVmFsdWUpIHx8XG4gICAgICB0aGlzLm90cENvbmZpZy5iZWhhdmlvciAhPT0gTmd4T3RwQmVoYXZpb3IuTEVHQUNZXG4gICAgKSB7XG4gICAgICB0aGlzLnN0ZXBCYWNrd2FyZChpbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZm9jdXNlZElucHV0SGFzVmFsdWUgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVGb2N1cyhpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5mb2N1c2VkSW5wdXRIYXNWYWx1ZSA9ICEhdGhpcy5uZ3hPdHBBcnJheS5jb250cm9sc1tpbmRleF0udmFsdWU7XG4gICAgaWYgKFxuICAgICAgdGhpcy5vdHBDb25maWcuYmVoYXZpb3IgPT09IE5neE90cEJlaGF2aW9yLkxFR0FDWSAmJlxuICAgICAgdGhpcy5mb2N1c2VkSW5wdXRIYXNWYWx1ZVxuICAgICkge1xuICAgICAgdGhpcy5pbnB1dHNbaW5kZXhdLnNlbGVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIHN0ZXBCYWNrd2FyZChpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKGluZGV4ID4gMCkge1xuICAgICAgdGhpcy5zZXRGb2N1cyhpbmRleCAtIDEpO1xuICAgIH1cbiAgfVxuXG4gIHN0ZXBGb3J3YXJkKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAoaW5kZXggPCB0aGlzLkxBU1RfSU5QVVRfSU5ERVgpIHtcbiAgICAgIHRoaXMuc2V0Rm9jdXMoaW5kZXggKyAxKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG90cEZvcm1DaGFuZ2VMaXN0ZW5lcigpOiB2b2lkIHtcbiAgICB0aGlzLm5neE90cEFycmF5JCA9IHRoaXMubmd4T3RwQXJyYXkudmFsdWVDaGFuZ2VzLnN1YnNjcmliZSgodmFsdWVzKSA9PiB7XG4gICAgICB0aGlzLm90cENoYW5nZS5lbWl0KHZhbHVlcyk7XG5cbiAgICAgIGlmICh0aGlzLm5neE90cEFycmF5LnZhbGlkKSB7XG4gICAgICAgIHRoaXMuZmlsbC5lbWl0KHZhbHVlcy5qb2luKCcnKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldFVwT3RwRm9ybSgpOiB2b2lkIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMub3RwQ29uZmlnLm90cExlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLm5neE90cEFycmF5LnB1c2goXG4gICAgICAgIG5ldyBVbnR5cGVkRm9ybUNvbnRyb2wobnVsbCwgW1ZhbGlkYXRvcnMucmVxdWlyZWRdKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFVwQXJpYUxhYmVscygpOiB2b2lkIHtcbiAgICBjb25zdCBsYWJlbHMgPSB0aGlzLm90cENvbmZpZy5hcmlhTGFiZWxzO1xuXG4gICAgdGhpcy5hcmlhTGFiZWxzID0gQXJyYXkuaXNBcnJheShsYWJlbHMpXG4gICAgICA/IGxhYmVsc1xuICAgICAgOiBuZXcgQXJyYXkodGhpcy5vdHBDb25maWcub3RwTGVuZ3RoKS5maWxsKFxuICAgICAgICAgIGxhYmVscyB8fCB0aGlzLkRFRkFVTFRfQVJJQV9MQUJFTFxuICAgICAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXROYXRpdmVIVE1MRWxlbWVudHMoKTogdm9pZCB7XG4gICAgdGhpcy5pbnB1dHMgPSB0aGlzLm90cElucHV0RWxlbWVudHMubWFwKChlbGVtZW50KSA9PiBlbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRJbml0aWFsRm9jdXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLmF1dG9mb2N1cykge1xuICAgICAgdGhpcy5zZXRGb2N1cygwKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEluaXRpYWxTdHlsZXMoKTogdm9pZCB7XG4gICAgdGhpcy5zdHlsZXMgPSB0aGlzLm5neE90cElucHV0U2VydmljZS5pbml0MkRBcnJheSh0aGlzLm90cENvbmZpZy5vdHBMZW5ndGgpO1xuICAgIHRoaXMuYWRkU3R5bGVUb0FsbCh0aGlzLm90cENvbmZpZy5jbGFzc0xpc3QuaW5wdXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRGb2N1cyhpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5pbnB1dHNbaW5kZXhdLmZvY3VzKCk7XG4gIH1cblxuICBwcml2YXRlIHNldE51bWVyaWNJbnB1dElmUG9zc2libGUoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLm51bWVyaWNJbnB1dE1vZGUpIHtcbiAgICAgIHRoaXMub3RwQ29uZmlnLnBhdHRlcm4gPSB0aGlzLmRlZmF1bHRQYXR0ZXJuO1xuICAgICAgdGhpcy5pbnB1dHMubWFwKChlbGVtZW50KSA9PiB7XG4gICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdpbnB1dG1vZGUnLCAnbnVtZXJpYycpO1xuICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgncGF0dGVybicsICdbMC05XSonKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYmx1cigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vdHBDb25maWcuYXV0b2JsdXIpIHtcbiAgICAgIHRoaXMuaW5wdXRzLm1hcCgoaW5wdXQpID0+IGlucHV0LmJsdXIoKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVQYXN0ZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub3RwQ29uZmlnLnBhdHRlcm4udGVzdCh2YWx1ZSkpIHtcbiAgICAgIGxldCBsYXN0SW5kZXggPSAwO1xuICAgICAgdmFsdWVcbiAgICAgICAgLnNwbGl0KCcnKVxuICAgICAgICAuc2xpY2UoMCwgdGhpcy5vdHBDb25maWcub3RwTGVuZ3RoKVxuICAgICAgICAubWFwKChjaGFyYWN0ZXI6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgIHRoaXMuYWRkU3R5bGUoaW5kZXgsIHRoaXMub3RwQ29uZmlnLmNsYXNzTGlzdD8uaW5wdXRGaWxsZWQpO1xuICAgICAgICAgIHRoaXMuZ2V0Rm9ybUNvbnRyb2xCeUluZGV4KGluZGV4KS5zZXRWYWx1ZShjaGFyYWN0ZXIpO1xuICAgICAgICAgIGxhc3RJbmRleCA9IGluZGV4O1xuICAgICAgICB9KTtcblxuICAgICAgaWYgKHRoaXMubmd4T3RwQXJyYXkudmFsaWQpIHtcbiAgICAgICAgdGhpcy5ibHVyKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNldEZvY3VzKGxhc3RJbmRleCArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRGlzYWJsZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKGlzRGlzYWJsZWQpIHtcbiAgICAgIHRoaXMubmd4T3RwQXJyYXkuZGlzYWJsZSgpO1xuICAgICAgdGhpcy5hZGRTdHlsZVRvQWxsKHRoaXMub3RwQ29uZmlnLmNsYXNzTGlzdD8uaW5wdXREaXNhYmxlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubmd4T3RwQXJyYXkuZW5hYmxlKCk7XG4gICAgICB0aGlzLnJlbW92ZVN0eWxlRnJvbUFsbCh0aGlzLm90cENvbmZpZy5jbGFzc0xpc3Q/LmlucHV0RGlzYWJsZWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlU3RhdHVzQ2hhbmdlKHN0YXR1czogTmd4T3RwU3RhdHVzKTogdm9pZCB7XG4gICAgdGhpcy5yZW1vdmVTdHlsZUZyb21BbGwoW1xuICAgICAgLi4udGhpcy5uZ3hPdHBJbnB1dFNlcnZpY2UudG9BcnJheShcbiAgICAgICAgdGhpcy5vdHBDb25maWcuY2xhc3NMaXN0Py5pbnB1dFN1Y2Nlc3NcbiAgICAgICksXG4gICAgICAuLi50aGlzLm5neE90cElucHV0U2VydmljZS50b0FycmF5KHRoaXMub3RwQ29uZmlnLmNsYXNzTGlzdD8uaW5wdXRFcnJvciksXG4gICAgXSk7XG5cbiAgICBpZiAoc3RhdHVzKSB7XG4gICAgICBpZiAoc3RhdHVzID09PSAnc3VjY2VzcycpIHtcbiAgICAgICAgdGhpcy5hZGRTdHlsZVRvQWxsKHRoaXMub3RwQ29uZmlnLmNsYXNzTGlzdD8uaW5wdXRTdWNjZXNzKTtcbiAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSAnZXJyb3InKSB7XG4gICAgICAgIHRoaXMuYWRkU3R5bGVUb0FsbCh0aGlzLm90cENvbmZpZy5jbGFzc0xpc3Q/LmlucHV0RXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Rm9ybUNvbnRyb2xCeUluZGV4KGluZGV4OiBudW1iZXIpOiBVbnR5cGVkRm9ybUNvbnRyb2wge1xuICAgIHJldHVybiB0aGlzLm5neE90cEFycmF5LmNvbnRyb2xzW2luZGV4XSBhcyBVbnR5cGVkRm9ybUNvbnRyb2w7XG4gIH1cblxuICBwcml2YXRlIGFkZFN0eWxlKGluZGV4OiBudW1iZXIsIHN0eWxlczogc3RyaW5nIHwgc3RyaW5nW10pOiB2b2lkIHtcbiAgICB0aGlzLnN0eWxlcyA9IHRoaXMubmd4T3RwSW5wdXRTZXJ2aWNlLmFkZEl0ZW1BdEluZGV4KFxuICAgICAgdGhpcy5zdHlsZXMsXG4gICAgICBpbmRleCxcbiAgICAgIHRoaXMubmd4T3RwSW5wdXRTZXJ2aWNlLnRvQXJyYXkoc3R5bGVzKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZFN0eWxlVG9BbGwoc3R5bGVzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IHZvaWQge1xuICAgIHRoaXMuc3R5bGVzID0gdGhpcy5uZ3hPdHBJbnB1dFNlcnZpY2UuYWRkSXRlbVRvQWxsKFxuICAgICAgdGhpcy5zdHlsZXMsXG4gICAgICB0aGlzLm5neE90cElucHV0U2VydmljZS50b0FycmF5KHN0eWxlcylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVTdHlsZShpbmRleDogbnVtYmVyLCBzdHlsZXM6IHN0cmluZyB8IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgdGhpcy5zdHlsZXMgPSB0aGlzLm5neE90cElucHV0U2VydmljZS5yZW1vdmVJdGVtQXRJbmRleChcbiAgICAgIHRoaXMuc3R5bGVzLFxuICAgICAgaW5kZXgsXG4gICAgICB0aGlzLm5neE90cElucHV0U2VydmljZS50b0FycmF5KHN0eWxlcylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVTdHlsZUZyb21BbGwoc3R5bGVzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IHZvaWQge1xuICAgIHRoaXMuc3R5bGVzID0gdGhpcy5uZ3hPdHBJbnB1dFNlcnZpY2UucmVtb3ZlSXRlbUZyb21BbGwoXG4gICAgICB0aGlzLnN0eWxlcyxcbiAgICAgIHRoaXMubmd4T3RwSW5wdXRTZXJ2aWNlLnRvQXJyYXkoc3R5bGVzKVxuICAgICk7XG4gIH1cbn1cbiIsIjxmb3JtXG4gIFtuZ0NsYXNzXT1cIm90cENvbmZpZy5jbGFzc0xpc3Q/LmNvbnRhaW5lclwiXG4gIGNsYXNzPVwibmd4LW90cC1pbnB1dC1jb250YWluZXJcIlxuPlxuICA8ZGl2XG4gICAgKm5nRm9yPVwibGV0IGNvbnRyb2wgb2Ygbmd4T3RwQXJyYXkuY29udHJvbHM7IGxldCBpID0gaW5kZXhcIlxuICAgIFtuZ0NsYXNzXT1cIm90cENvbmZpZy5jbGFzc0xpc3Q/LmlucHV0Qm94XCJcbiAgICBjbGFzcz1cIm5neC1vdHAtaW5wdXQtYm94XCJcbiAgPlxuICAgIDxsYWJlbCBbYXR0ci5hcmlhLWxhYmVsXT1cImFyaWFMYWJlbHNbaV1cIj5cbiAgICAgIDxpbnB1dFxuICAgICAgICAjb3RwSW5wdXRFbGVtZW50XG4gICAgICAgIFtpZF09XCInbmd4LW90cC1pbnB1dC0nICsgaVwiXG4gICAgICAgIFtmb3JtQ29udHJvbF09XCJjb250cm9sXCJcbiAgICAgICAgW25neE90cFBhdHRlcm5dPVwib3RwQ29uZmlnLnBhdHRlcm5cIlxuICAgICAgICBbdHlwZV09XCJvdHBDb25maWcuaXNQYXNzd29yZElucHV0ID8gJ3Bhc3N3b3JkJyA6ICd0ZXh0J1wiXG4gICAgICAgICAgW25nQ2xhc3NdPVwic3R5bGVzPy5sZW5ndGggPiAwID8gc3R5bGVzW2ldIDogbnVsbFwiXG4gICAgICAgIChrZXl1cCk9XCJoYW5kbGVLZXlVcChpLCAkZXZlbnQua2V5KVwiXG4gICAgICAgIChrZXl1cC5iYWNrc3BhY2UpPVwiaGFuZGxlRGVsZXRlKGkpXCJcbiAgICAgICAgKGtleXVwLmFycm93TGVmdCk9XCJzdGVwQmFja3dhcmQoaSlcIlxuICAgICAgICAoa2V5dXAuYXJyb3dSaWdodCk9XCJzdGVwRm9yd2FyZChpKVwiXG4gICAgICAgIChmb2N1cyk9XCJoYW5kbGVGb2N1cyhpKVwiXG4gICAgICAgIGNsYXNzPVwibmd4LW90cC1pbnB1dFwiXG4gICAgICAgIG1heGxlbmd0aD1cIjFcIlxuICAgICAgICBhdXRvY2FwaXRhbGl6ZT1cIm9mZlwiXG4gICAgICAgIHNwZWxsY2hlY2s9XCJmYWxzZVwiXG4gICAgICAvPlxuICAgIDwvbGFiZWw+XG4gIDwvZGl2PlxuPC9mb3JtPlxuIl19